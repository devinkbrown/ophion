/*
 * atheme.conf — Atheme IRC Services configuration for Ophion
 *
 * Replace every value marked CHANGEME before deploying.
 *
 * Sections:
 *   1.  Module loading
 *   2.  Server identity
 *   3.  Uplink (connection to Ophion)
 *   4.  General options
 *   5.  NickServ
 *   6.  ChanServ
 *   7.  MemoServ
 *   8.  OperServ
 *   9.  InfoServ
 *  10.  SASL agent
 */


/* ==========================================================================
 * 1. MODULE LOADING
 * ========================================================================== */

/* Protocol — use the Ophion-specific module (wraps protocol/charybdis). */
loadmodule "protocol/ophion";

/* Database backend. */
loadmodule "backend/opensex";

/* Password hashing — strongly recommended. */
loadmodule "crypto/pbkdf2v2";

/* Core services. */
loadmodule "nickserv/main";
loadmodule "chanserv/main";
loadmodule "memoserv/main";
loadmodule "operserv/main";
loadmodule "infoserv/main";

/* NickServ commands. */
loadmodule "nickserv/register";
loadmodule "nickserv/identify";
loadmodule "nickserv/logout";
loadmodule "nickserv/drop";
loadmodule "nickserv/set";
loadmodule "nickserv/set_email";
loadmodule "nickserv/set_password";
loadmodule "nickserv/set_hidemail";
loadmodule "nickserv/set_nogreet";
loadmodule "nickserv/info";
loadmodule "nickserv/list";
loadmodule "nickserv/ghost";
loadmodule "nickserv/release";
loadmodule "nickserv/regain";
loadmodule "nickserv/sendpass";
loadmodule "nickserv/resetpass";
loadmodule "nickserv/cert";           /* certificate fingerprint login */
loadmodule "nickserv/access";
loadmodule "nickserv/group";
loadmodule "nickserv/link";
loadmodule "nickserv/unlink";
loadmodule "nickserv/status";
loadmodule "nickserv/taxonomy";
loadmodule "nickserv/verify";

/* ChanServ commands. */
loadmodule "chanserv/register";
loadmodule "chanserv/drop";
loadmodule "chanserv/set";
loadmodule "chanserv/set_email";
loadmodule "chanserv/set_url";
loadmodule "chanserv/set_entrymsg";
loadmodule "chanserv/set_guard";
loadmodule "chanserv/set_keeptopic";
loadmodule "chanserv/set_mlock";
loadmodule "chanserv/set_nosync";
loadmodule "chanserv/set_property";
loadmodule "chanserv/set_restricted";
loadmodule "chanserv/set_secure";
loadmodule "chanserv/set_verbose";
loadmodule "chanserv/flags";
loadmodule "chanserv/info";
loadmodule "chanserv/list";
loadmodule "chanserv/invite";
loadmodule "chanserv/op";
loadmodule "chanserv/voice";
loadmodule "chanserv/kick";
loadmodule "chanserv/ban";
loadmodule "chanserv/unban";
loadmodule "chanserv/quiet";
loadmodule "chanserv/topic";
loadmodule "chanserv/topicappend";
loadmodule "chanserv/getkey";
loadmodule "chanserv/clear";
loadmodule "chanserv/why";
loadmodule "chanserv/access";
loadmodule "chanserv/akick";
loadmodule "chanserv/taxonomy";
loadmodule "chanserv/sync";
loadmodule "chanserv/successor";

/* MemoServ commands. */
loadmodule "memoserv/send";
loadmodule "memoserv/sendops";
loadmodule "memoserv/list";
loadmodule "memoserv/read";
loadmodule "memoserv/delete";
loadmodule "memoserv/forward";
loadmodule "memoserv/ignore";

/* OperServ commands. */
loadmodule "operserv/akill";
loadmodule "operserv/sgline";
loadmodule "operserv/sqline";
loadmodule "operserv/ignore";
loadmodule "operserv/clones";
loadmodule "operserv/noop";
loadmodule "operserv/mode";
loadmodule "operserv/kick";
loadmodule "operserv/jupe";
loadmodule "operserv/list";
loadmodule "operserv/inject";
loadmodule "operserv/override";
loadmodule "operserv/identify";

/* SASL authentication agent. */
loadmodule "saslserv/main";
loadmodule "saslserv/scram-sha";     /* SCRAM-SHA-256 / SCRAM-SHA-512   */
loadmodule "saslserv/plain";         /* PLAIN (require TLS on the IRCd) */
loadmodule "saslserv/external";      /* EXTERNAL (client certificates)  */

/* Protocol mixin: Ophion doesn't use halfops, protect, or owner modes. */
loadmodule "protocol/mixin_nohalfops";
loadmodule "protocol/mixin_noprotect";
loadmodule "protocol/mixin_noowner";

/* Hostname cloaking — vhost-style cloaks for identified users. */
loadmodule "hostserv/main";
loadmodule "hostserv/offer";
loadmodule "hostserv/take";
loadmodule "hostserv/request";
loadmodule "hostserv/activate";
loadmodule "hostserv/reject";
loadmodule "hostserv/listvhost";
loadmodule "hostserv/onoff";
loadmodule "hostserv/del";
loadmodule "hostserv/group";


/* ==========================================================================
 * 2. SERVER IDENTITY
 * ========================================================================== */

serverinfo {
	/*
	 * name: the server name Atheme will introduce itself with.
	 * Must match the "name" field in the Ophion connect{} block.
	 */
	name        = "services.irc.example.com";   /* CHANGEME */

	/*
	 * desc: description shown in /LINKS and /MAP.
	 */
	desc        = "Ophion IRC Services";

	/*
	 * numeric: arbitrary unique numeric for this services server.
	 * Keep it well away from 0 (the hub) and any other servers.
	 */
	numeric     = 42;

	/*
	 * adminname / adminemail: shown in /ADMIN responses.
	 */
	adminname   = "Network Administrator";      /* CHANGEME */
	adminemail  = "admin@example.com";          /* CHANGEME */

	/*
	 * Large enough for a busy bridged network.
	 */
	maxlogins   = 5;
};


/* ==========================================================================
 * 3. UPLINK — connection to the Ophion IRCd
 * ========================================================================== */

uplink "irc.example.com" {             /* CHANGEME: Ophion server hostname */
	/*
	 * host: IP/hostname of the Ophion server.
	 * Should match the 'host =' in Ophion's connect{} block for services.
	 */
	host        = "127.0.0.1";         /* CHANGEME */
	port        = 6667;                /* or 6697 for TLS               */

	/*
	 * send_password / receive_password must match the
	 * send_password / accept_password in Ophion's connect{} block
	 * (with the direction reversed).
	 *
	 * In Ophion ircd.conf:
	 *
	 *   connect "services.irc.example.com" {
	 *       host = "127.0.0.1";
	 *       send_password    = "OPHION_TO_SERVICES";   # CHANGEME
	 *       accept_password  = "SERVICES_TO_OPHION";   # CHANGEME
	 *       port = 6667;
	 *       class = "server";
	 *   };
	 *
	 * Atheme's send_password becomes the IRCd's accept_password and
	 * vice-versa.
	 */
	send_password    = "SERVICES_TO_OPHION";    /* CHANGEME */
	receive_password = "OPHION_TO_SERVICES";    /* CHANGEME */

	/* TLS — enable if using port 6697 with a valid certificate. */
	#tls;
};


/* ==========================================================================
 * 4. GENERAL OPTIONS
 * ========================================================================== */

general {
	/*
	 * ratelimit_uses / ratelimit_period: throttle commands to prevent
	 * abuse from clients that can't authenticate (e.g. Discord-side bots
	 * trying to spam NickServ IDENTIFY).
	 */
	ratelimit_uses   = 6;
	ratelimit_period = 60;

	/*
	 * flood_msgs / flood_time: ignore a user sending too many commands.
	 */
	flood_msgs  = 8;
	flood_time  = 5;

	/*
	 * kline_time: default duration for OperServ AKILLs (seconds).
	 * 0 = permanent.
	 */
	kline_time  = 86400;             /* 1 day default */

	/*
	 * commit_interval: how often (seconds) to write the database.
	 */
	commit_interval = 300;           /* 5 minutes */

	/*
	 * expire: how many days before unverified / unused accounts expire.
	 */
	expire      = 30;

	/*
	 * Default language for service messages.
	 */
	language    = "en";

	/*
	 * Permit only TLS connections to the services pseudo-server.
	 * Comment out if running plaintext (e.g. loopback-only setup).
	 */
	#secure;

	/*
	 * Discord bridge notice
	 * ---------------------
	 * Ophion introduces Discord users as phantom clients with umode +S
	 * and hostname "discord.invalid".  Atheme treats +S clients as
	 * network services and will NOT send them SASL prompts, NickServ
	 * IDENTIFY requests, or nick enforcement notices.  This is the
	 * correct behaviour and requires no special configuration here.
	 *
	 * If you want to prevent real IRC users from registering nicks that
	 * match common Discord usernames, you can add them to the NickServ
	 * forbid list:
	 *
	 *   /msg NickServ FORBID <nick>
	 *
	 * ChanServ channels that are Discord-bridged work normally — the
	 * phantom users will appear in /NAMES and can be voiced/banned
	 * exactly like regular IRC users.  ChanServ AKICK entries will
	 * match against their nick!discord@discord.invalid mask.
	 */
};


/* ==========================================================================
 * 5. NICKSERV
 * ========================================================================== */

nickserv {
	/*
	 * nick: the nickname NickServ presents on IRC.
	 */
	nick    = "NickServ";
	user    = "NickServ";
	host    = "services.irc.example.com";   /* CHANGEME to match serverinfo::name */
	real    = "Nickname Services";

	/*
	 * spam: advertise NickServ to new users on connect.
	 */
	spam;

	/*
	 * enforcetime: seconds before nick enforcement kicks a user off a
	 * protected nickname.
	 */
	enforcetime = 30;

	/*
	 * maxnicks: maximum number of grouped nicks per account.
	 */
	maxnicks    = 5;

	/*
	 * expire: days before an unverified or idle registration expires.
	 * Overrides general::expire for NickServ specifically.
	 */
	expire      = 30;

	/*
	 * waitreg_time: seconds a user must wait before registering (rate
	 * limits registration floods).
	 */
	waitreg_time = 60;
};


/* ==========================================================================
 * 6. CHANSERV
 * ========================================================================== */

chanserv {
	nick    = "ChanServ";
	user    = "ChanServ";
	host    = "services.irc.example.com";   /* CHANGEME */
	real    = "Channel Services";

	/*
	 * maxchans: maximum channels a single account may register.
	 */
	maxchans    = 10;

	/*
	 * changets: when ChanServ joins a channel, give it a TS older than
	 * the channel's real TS so it can set modes without a deop fight.
	 */
	changets;

	/*
	 * expiry: days before an unused channel registration expires.
	 */
	expire      = 60;

	/*
	 * akick_time: default duration for AKICK entries (0 = permanent).
	 */
	akick_time  = 0;
};


/* ==========================================================================
 * 7. MEMOSERV
 * ========================================================================== */

memoserv {
	nick    = "MemoServ";
	user    = "MemoServ";
	host    = "services.irc.example.com";   /* CHANGEME */
	real    = "Memo Services";

	/*
	 * maxmemos: maximum stored memos per account.
	 */
	maxmemos    = 30;
};


/* ==========================================================================
 * 8. OPERSERV
 * ========================================================================== */

operserv {
	nick    = "OperServ";
	user    = "OperServ";
	host    = "services.irc.example.com";   /* CHANGEME */
	real    = "Operator Services";
};


/* ==========================================================================
 * 9. INFOSERV
 * ========================================================================== */

infoserv {
	nick    = "InfoServ";
	user    = "InfoServ";
	host    = "services.irc.example.com";   /* CHANGEME */
	real    = "Information Services";
};


/* ==========================================================================
 * 10. SASL AGENT
 * ========================================================================== */

saslserv {
	nick    = "SaslServ";
	user    = "SaslServ";
	host    = "services.irc.example.com";   /* CHANGEME */
	real    = "SASL Authentication Agent";
};


/* ==========================================================================
 * HOSTSERV (optional — provides virtual hosts for identified users)
 * ========================================================================== */

hostserv {
	nick    = "HostServ";
	user    = "HostServ";
	host    = "services.irc.example.com";   /* CHANGEME */
	real    = "Virtual Host Services";

	/*
	 * suffixes: only allow vhosts with these suffixes, preventing users
	 * from spoofing "discord.invalid" (the phantom client hostname).
	 */
	vhostsuffixes = ".users.example.com";   /* CHANGEME */
};


/* ==========================================================================
 * OPERATOR PRIVILEGES
 * ========================================================================== */

/*
 * operator {}: grants an Atheme services operator account.
 * The "name" here is an IRC nick, and "password" is the services password.
 *
 * Remove or change before deployment.
 */
operator "admin" {               /* CHANGEME: services admin account name */
	password    = "CHANGEME";
	flags       = SOPER_ADMIN;
};
