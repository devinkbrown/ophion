SASL authentication for IRC operators
======================================

Ophion uses SASL to authenticate IRC operators.  Authentication runs during
connection registration — before the client receives the 001 Welcome — and
oper status is granted automatically at registration completion.

The traditional OPER command is a stub; it prints a redirect notice and
performs no authentication.  All oper auth goes through SASL PLAIN (password)
or SASL EXTERNAL (TLS certificate fingerprint).

The IRCX AUTH command (m_ircx_auth) provides a single-command shorthand for
the same SASL mechanisms without requiring the CAP REQ :sasl negotiation.


Overview
--------

SASL (Simple Authentication and Security Layer, RFC 4422) is a framework
that separates the authentication mechanism from the protocol.  In IRC, SASL
runs via the AUTHENTICATE command with the sasl client capability.

Connection registration flow:

    Client → Server:  CAP REQ :sasl
    Server → Client:  CAP * ACK :sasl
    Client → Server:  NICK <nick>
    Client → Server:  USER <user> 0 * :<gecos>
    Client → Server:  AUTHENTICATE <mechanism>
    Server → Client:  AUTHENTICATE +             (no server challenge for PLAIN/EXTERNAL)
    Client → Server:  AUTHENTICATE <base64-payload>
    Server → Client:  900 RPL_LOGGEDIN           (on success)
    Server → Client:  903 RPL_SASLSUCCESS        (on success)
                   or 904 ERR_SASLFAIL           (on failure)
    Client → Server:  CAP END
    Server → Client:  001 Welcome                <- oper_up() fires here automatically


Mechanism: PLAIN (password-based)
----------------------------------

SASL PLAIN (RFC 4616) carries credentials in a single binary blob:

    [authzid] NUL authcid NUL password

Fields:

    authzid   Optional authorization identity.  If non-empty it must equal
              authcid.  Most clients leave this empty.

    authcid   Authentication identity: the operator block name.

    password  The operator block password (protected by TLS, not by base64).

The blob is base64-encoded before being sent:

    printf '\0<blockname>\0<password>' | base64

Full exchange:

    C: CAP REQ :sasl
    C: NICK alice
    C: USER alice 0 * :Alice
    S: :server CAP alice ACK :sasl
    C: AUTHENTICATE PLAIN
    S: AUTHENTICATE +
    C: AUTHENTICATE AGdvZG9wZXIAczNjcmV0
      (= base64 of \0godoper\0s3cret)
    S: :server 900 alice alice!alice@host godoper :You are now logged in as godoper
    S: :server 903 alice :SASL authentication successful
    C: CAP END
    S: :server 001 alice :Welcome ...
      (oper_up() fires automatically)

IRCX AUTH shorthand (no CAP REQ needed):

    AUTH PLAIN I :AGdvZG9wZXIAczNjcmV0

    Syntax: AUTH <mechanism> <sequence> :<base64-payload>
    "I" = Initial.

Client configuration:

    WeeChat:
      /set irc.server.mynet.sasl_mechanism plain
      /set irc.server.mynet.sasl_username godoper
      /set irc.server.mynet.sasl_password s3cret

    irssi:
      /set sasl_mechanism PLAIN
      /set sasl_username godoper
      /set sasl_password s3cret


Mechanism: EXTERNAL (certificate fingerprint)
----------------------------------------------

SASL EXTERNAL authenticates using the TLS client certificate presented at the
TLS handshake.  Only operator blocks with the certfp_only flag are eligible.
No password is involved or checked.

The payload the client sends is the authzid (operator block name) or empty:

    Empty / "=":  Server scans all certfp_only blocks for the one whose
                  fingerprint matches the client's certificate (auto-discover).

    "blockname":  Server checks that specific block's fingerprint against
                  the client's certificate.

Full exchange (auto-discover):

    C: CAP REQ :sasl
    C: NICK alice
    C: USER alice 0 * :Alice
    C: AUTHENTICATE EXTERNAL
    S: AUTHENTICATE +
    C: AUTHENTICATE =
    S: :server 903 alice :SASL authentication successful
    C: CAP END
    S: :server 001 alice :Welcome ...
      (oper_up() fires automatically)

Named block (base64 of the block name):

    C: AUTHENTICATE EXTERNAL
    S: AUTHENTICATE +
    C: AUTHENTICATE Y2VydG9wZXI=    (= base64("certoper"))
    S: :server 903 alice :SASL authentication successful

IRCX AUTH shorthand:

    AUTH EXTERNAL I

    No data payload.  Authzid is implicitly empty; auto-discovery applies.

Client configuration:

    WeeChat:
      /set irc.server.mynet.sasl_mechanism external
      /set irc.server.mynet.ssl_cert /path/to/client.pem


ircd.conf operator{} blocks
-----------------------------

The operator block name is the authcid / authzid used in the SASL payload.

Password-based:

    operator "godoper" {
        user = "*@127.0.0.1";
        password = "$6$rounds=65536$...mkpasswd sha512 output...";
        flags = encrypted;
        snomask = "+Zbfkrsuy";
        privset = "admin";
    };

Certificate-only (no password; any host accepted automatically):

    operator "certoper" {
        fingerprint = "cert_sha256:deadbeefdeadbeef...64hexchars...";
        flags = certfp_only;
        snomask = "+Zbfkrsuy";
        privset = "admin";
    };

Certificate + password (both must match):

    operator "strictoper" {
        user = "alice@trusted.example.com";
        password = "etcnjl8juSU1E";
        fingerprint = "cert_sha256:deadbeefdeadbeef...64hexchars...";
        flags = encrypted, need_ssl;
        snomask = "+Zbfkrsuy";
        privset = "global_op";
    };

Operator block flags:

    encrypted     Password is crypt(3)-hashed [DEFAULT]
    ~encrypted    Password is stored plaintext
    need_ssl      Require TLS connection to authenticate
    certfp_only   Fingerprint alone is sufficient; no password needed.
                  Requires fingerprint = to be set.
                  Without user = lines, any host is accepted (*@*).


Getting your certificate fingerprint
--------------------------------------

    openssl x509 -in client.crt -noout -sha256 -fingerprint \
      | tr -d ':' | tr 'A-Z' 'a-z' \
      | sed 's/.*=//; s/^/cert_sha256:/'

The tools/setup.py configuration wizard can compute fingerprints interactively.

Fingerprint method prefixes (set certfp_method in general{}):

    cert_sha1:<hex>     SHA-1 of DER certificate
    cert_sha256:<hex>   SHA-256 of DER certificate [default]
    cert_sha512:<hex>   SHA-512 of DER certificate
    spki_sha256:<hex>   SHA-256 of SubjectPublicKeyInfo (survives certificate renewal)
    spki_sha512:<hex>   SHA-512 of SubjectPublicKeyInfo


Failure responses
-----------------

    904 ERR_SASLFAIL       Authentication failed (wrong password, certfp
                           mismatch, unknown block, or no client certificate)
    909 ERR_SASLTOOLONG    Payload exceeded 400 characters

Failures are logged at L_FOPER level.  When failed_oper_notice = yes in
general{}, a SNO_GENERAL notice is also broadcast to all online operators.


Internal implementation
------------------------

    modules/sasl_plain.c      SASL PLAIN mechanism module
    modules/sasl_external.c   SASL EXTERNAL mechanism module
    modules/m_sasl_core.c     AUTHENTICATE command and session management
    modules/m_ircx_auth.c     IRCX AUTH command (SASL shorthand)
    ircd/auth_oper.c          Shared credential and audit helpers

Shared helpers in auth_oper.c:

    oper_find_by_name(name)         Find block by name (no host check)
    oper_find_certfp_only(name)     Find certfp_only block by name
    oper_find_certfp_match(client)  Auto-discover certfp_only block by cert
    oper_check_password(pass, blk)  Verify password (plaintext or crypt)
    oper_check_certfp(client, blk)  Compare fingerprints (case-insensitive)
    oper_log_success(client, blk, method)  Emit L_OPERED audit entry
    oper_log_failure(client, name, reason, method)  Emit L_FOPER + snomask

On success the mechanism sets client->localClient->pending_oper.
register_local_user() (ircd/s_user.c) calls oper_up() at 001 Welcome.


References
----------

[1] RFC 4422 — Simple Authentication and Security Layer (SASL)
    https://tools.ietf.org/html/rfc4422

[2] RFC 4616 — The PLAIN SASL Mechanism
    https://tools.ietf.org/html/rfc4616

[3] IRCv3 SASL specification
    https://ircv3.net/specs/extensions/sasl-3.1

[4] IRCX draft — AUTH command
    draft-pfenning-irc-extensions-04
