Extended bans
Jilles Tjoelker <jilles -at- stack.nl>
--------------------------------------

Extended bans (ban conditionals) allow different checks than the usual
nick!user@host or nick!user@ip match to determine whether someone should
be banned, quieted, exempted or invited.

Extended bans are of the form $[~]<type>[:<data>]. The <type> is one
character (case insensitive) and determines the type of match. Most types
allow or require an extra field <data>. If the tilde (~) is present, the
result of the comparison will be negated, unless the ban is invalid in which
case it will never match. Invalid bans are ones where <data> is missing but
required or where <data> is otherwise invalid as noted below.

Unless noted below, all types can be used with +b, +Z, +e and +I.
(Note: in Ophion, +q is the channel-admin status mode; the quiet/mute
list uses +Z instead of the charybdis +q.)

If any extended ban types are loaded, they are listed in 005 (RPL_ISUPPORT)
as EXTBAN=$,<types>.

Local users cannot add extended bans of an unknown type or invalid bans. If a
remote user adds an extended ban of an unknown type, the mode change is
processed normally. Furthermore, extended bans of an unknown type can always be
listed or removed.

The ability to send to a channel is cached; this cache may not be updated
if a condition for an extended ban changes. To work around this, part and
rejoin the channel, or add or remove a +b, +Z or +e entry.

CORE EXTENDED BAN TYPES
-----------------------

These are loaded with the core modules and always available.

extb_account.so  ($a)
	$a
matches all logged-in users (users with a services account)
	$a:<mask>
matches users logged in with an account name matching the mask (* and ?
wildcards). Invalid if mask is empty.

extb_group.so  ($g)
	$g:<mask>
matches users whose MEMBER-OF property contains the given string. Requires
the m_ircx_prop_member_of module and services that set the MEMBER-OF user
property. The match is a case-insensitive substring search. Invalid if mask
is missing.

extb_ssl.so  ($z)
	$z
matches users connected via SSL/TLS (umode +Z set). Covers both TLS port
connections and STARTTLS upgrades. Can be used with all ban list types.

EXTENSION EXTENDED BAN TYPES
-----------------------------

These are located in the extensions/ directory and must be loaded explicitly.

extb_canjoin.so  ($j)
	$j:<channel>
matches users who are banned from the given channel (i.e. would not be
allowed to join it). Useful for mirroring a ban list from one channel to
another. Invalid if the given channel does not exist, if the ban would
create a circular reference (same channel), or if the recursion depth limit
is exceeded. Can only be used with +b and +Z.

extb_channel.so  ($c)
	$c:<channel>
matches users who are currently on the given channel. This is only valid if
the channel exists and is not +s or +p. The ops of the channel the ban is
on cannot necessarily see whether the user is in the target channel, so it
should not influence whether they can join either. Can only be used with
+b and +Z.

extb_combi.so  ($& and $|)
	$&<ban1>,<ban2>[,<ban3>...]
matches users who match ALL of the specified bans (logical AND).
	$|<ban1>,<ban2>[,<ban3>...]
matches users who match ANY of the specified bans (logical OR).

Combination bans allow complex matching rules. The sub-bans may be any valid
extended ban including other combination bans (up to a nesting depth limit).
The ircd will not allow adding a combination ban that references an unknown
extban type.

Example: $&$z,$a  -- matches SSL users who are also logged in.
Example: $|$a:TrustedBot,$z  -- matches all SSL users or the TrustedBot account.
Example: $~$&$a,$z  -- negation: not (logged-in AND SSL).

extb_extgecos.so  ($x)
	$x:<nick!user@host:gecos>
matches users whose full nick!user@host:realname string matches the mask.
Supports * and ? wildcards in any field. If the user has a dynamic spoof,
the real hostname is also checked. Invalid if mask is missing. Can only be
used with +b and +Z.

extb_hostmask.so  ($m)
	$m:<nick!user@host>
matches users whose nick!user@host matches the given mask. Designed
primarily for use inside combination extbans ($& / $|) as a named hostmask
check. Supports * and ? wildcards.

extb_oper.so  ($o)
	$o
matches IRC operators (umode +o set). Most useful with +I (invite exception)
to allow opers into an invite-only channel, or with +e to exempt opers from
+b bans.

extb_realname.so  ($r)
	$r:<mask>
matches users with a realname (gecos) matching the mask (* and ? wildcards).
Invalid if mask is missing. Can only be used with +b and +Z.

extb_server.so  ($s)
	$s:<mask>
matches users connected to a server whose name matches the mask (* and ?
wildcards). Invalid if mask is missing. Can only be used with +b and +Z.

extb_usermode.so  ($u)
	$u:<modes>
matches users who have (or do not have) the specified user modes. The modes
parameter uses standard +/- prefix notation: modes after + must be set,
modes after - must not be set. If no sign is given, + is assumed. Invalid
if modes parameter is missing or contains unknown modes.

Examples:
  $u:+Z        -- matches SSL users (same as $z if extb_ssl loaded)
  $u:-r        -- matches users without an account (+r not set)
  $u:+Zi       -- matches users who are SSL and invisible

COMMON USE CASES
----------------

+b $~a      Prevents non-logged-in users from joining (like +r).  Also
            prevents non-logged-in users already on channel from talking or
            changing their nick.

+b $~z      Bans users who are not using SSL/TLS.  Usually combined with
            chm_sslonly or used in exceptions (+e $z to allow SSL users).

+iI $o      Same as +O in dreamforge-derived ircds: makes channel oper-only
            by requiring an invite, but exempting all opers.

+b $s:*     Ban all users from any server (extreme case; not usually useful).

+b $&$~a,$~z  Require both account and SSL: ban anyone without both.

EXTBANS IN THE ACCESS COMMAND
------------------------------

Extended bans can be used as mask arguments in the IRCX ACCESS command
for all membership levels (VOICE, HOST/OP, OWNER/ADMIN). This lets
administrators grant channel access based on account name, SSL status,
group membership, and other extban criteria rather than just
nick!user@host masks.

ACCESS #channel ADD VOICE $a
    Grant VOICE to any logged-in user.

ACCESS #channel ADD HOST $a:TrustedOps
    Grant HOST (chanop) to any user logged in as "TrustedOps".

ACCESS #channel ADD OWNER $o
    Grant OWNER to any IRC operator.

ACCESS #channel ADD VOICE $z
    Grant VOICE to all SSL/TLS connected users.

ACCESS #channel ADD HOST $&$a,$z
    Grant HOST only to logged-in SSL users (both conditions).

ACCESS #channel ADD VOICE $g:Staff
    Grant VOICE to users in the "Staff" group (via MEMBER-OF property,
    requires m_ircx_prop_member_of and supporting services).

DENY and GRANT levels still route through the channel mode lists (+b and
+I respectively) and accept any extban that the mode system accepts.

QUIET entries route through the quiet list (+Z) and also accept extbans.

The server validates that any mask starting with '$' uses a registered
extban type. State-dependent extbans (e.g. $j with a channel that does
not yet exist) can still be added; they simply will not match until their
preconditions are met.

CREATING CUSTOM EXTBAN TYPES
-----------------------------

extban_table, indexed by the extban character, contains function pointers
of the following type:

typedef int (*ExtbanFunc)(const char *data, struct Client *client_p,
		struct Channel *chptr, long mode_type);

The arguments are as follows:
data: the text after the colon, NULL if there was no colon
client_p: the client to check; this is always a local client, which may be
on or off channel
chptr: the channel
mode_type: CHFL_BAN, CHFL_QUIET, CHFL_EXCEPTION or CHFL_INVEX

The return value:
EXTBAN_INVALID: the mask is invalid, it never matches even if negated and
cannot be added; if this is returned for one client_p it must be returned
for all
EXTBAN_NOMATCH: the client_p does not match the mask
EXTBAN_MATCH: the client_p matches the mask

The function is called whenever a (local) client needs to be checked against
a +bZeI entry of the given extban type, and whenever a local client tries to
add such an entry. (Clients are allowed to add bans matching themselves.)
