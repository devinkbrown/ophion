------------------------------------------------------
-    Oper Challenge/Response System Documentation    -
- Copyright (C) 2006 Lee Hardy <lee -at- leeh.co.uk> -
- Copyright (C) 2006 ircd-ratbox development team    -
------------------------------------------------------

The challenge/response system allows the ability to oper though public key
authentication, without the insecurity of oper passwords.

The challenge system documented here was redesigned in
ircd-ratbox-2.2/charybdis-1.1 and is not compatible with earlier versions.

Ophion implements the CHALLENGE command via the m_challenge module, which
uses wolfSSL (an OpenSSL-compatible TLS library) for the RSA operations.
The challenge/response system works identically to charybdis; the change
in TLS backend is transparent.

This document does not describe the technical details of the challenge
system.  The ratbox-respond client tool can be used to generate responses;
see http://respond.ircd-ratbox.org for more information and downloads.
ratbox-respond requires OpenSSL or an OpenSSL-compatible library (such as
wolfSSL) to build.


- Challenge basics -
--------------------
When a user requests a challenge to oper up, the ircd takes some random
data, encodes it using the opers public key, encodes this output in base64
and sends it to the user as a challenge.  The server then stores a hash of
the original random data.

The user must then decrypt the data using their private key and generate a
hash of the decrypted data.  Then the hash is base64 encoded and sent back
to the server.

If the stored hash the server has matches the reply from the client, they
are opered up.


- Generating a public/private keypair -
---------------------------------------
The first step is to use the makekeypair script to generate a public and
private key.  The public key is set in the ircd config (operator {};
rsa_public_key_file) instead of a password, and the private key should 
be kept secret.  It is highly recommended that the key is generated with 
a secure password.  Generating keys without a password is fundamentally
insecure.


The commands used in makekeypair to generate keys are as follows:
	openssl genrsa -out private.key -aes256 2048
	openssl rsa -in private.key -out public.key -pubout

If aes256 is not available, the following is used instead:
	openssl genrsa -out private.key -des3 2048


- Building ratbox-respond -
---------------------------
If you are using the unix based ratbox-respond this must be built.  For the
windows version, ratbox-winrespond, please see http://respond.ircd-ratbox.org

ratbox-respond takes the challenge from the server, and together with your
private key file generates a response to be sent back.  ratbox-respond
requires OpenSSL headers and libraries (or a compatible implementation
such as wolfSSL) to build.

Change into the ratbox-respond directory, and run:
	./configure
	make

This will generate a 'ratbox-respond' binary, which you may place wherever
you like.  If configure does not detect your OpenSSL installation, pass the
base directory (containing lib/ and include/openssl/) via:
	./configure --enable-openssl=/path/to/opensslbase

On systems using wolfSSL with its OpenSSL compatibility headers, you can
point ratbox-respond at the wolfSSL include directory:
	./configure --enable-openssl=/usr/include/wolfssl


- Opering up -
--------------
Once you have your public key set in ircd and built ratbox-respond, you oper
up by issuing "/challenge <opername>".  You should then run:
	/path/to/ratbox-respond /path/to/private.key
and input the challenge.  This will give you a response to paste back to the
server.  The ratbox-respond binary also accepts piped input, see
ratbox-respond/README for more information.

A number of scripts for clients have already been written to automate this
process, see client-scripts/README for more information.

